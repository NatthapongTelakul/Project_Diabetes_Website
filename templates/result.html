{% extends "header.html" %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/style-result.css') }}">

<div class="result-container">
    <!-- Header Section -->
    <div class="result-header">
        <h1>ผลการประเมิน</h1>
        <p>{{ prediction_datetime.strftime('%d %B %Y, %H:%M') if prediction_datetime else '' }}</p>
    </div>

    <!-- Risk Result Card (Combined Status) -->
    <div class="risk-card">
        <div class="risk-indicator">
            <div class="risk-circle risk-circle-{{ risk_data.risk_color }}">
                {% if risk_data.risk_icon %}
                    <img src="{{ url_for('static', filename='images/risk_icons/' + risk_data.risk_icon) }}" 
                         alt="{{ risk_data.risk_level }}" class="risk-icon-image">
                {% else %}
                    <span class="risk-icon">?</span>
                {% endif %}
            </div>
        </div>

        <div class="risk-content">
            <!-- Status Label -->
            <div class="status-label-section">
                {% if prediction == 1 %}
                    <span class="status-badge status-positive">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>มีความเสี่ยงเป็นโรคเบาหวาน</span>
                    </span>
                {% else %}
                    <span class="status-badge status-negative">
                        <i class="fas fa-check-circle"></i>
                        <span>ไม่มีความเสี่ยงเป็นโรคเบาหวาน</span>
                    </span>
                {% endif %}
            </div>

            <h2>{{ risk_data.risk_level }}</h2>
            <div class="probability-display">
                <span class="probability-label">ความเสี่ยงเบาหวาน:</span>
                <span class="probability-value">{{ "%.2f"|format(probability) }}%</span>
            </div>
            
            <!-- Risk Meter -->
            <div class="risk-meter">
                <div class="meter-track">
                    <div class="meter-fill" style="width: {{ probability }}%; background: 
                        {% if probability < 50 %}linear-gradient(90deg, #059669 0%, #047857 100%)
                        {% elif probability < 60 %}linear-gradient(90deg, #10b981 0%, #059669 100%)
                        {% elif probability < 70 %}linear-gradient(90deg, #eab308 0%, #ca8a04 100%)
                        {% elif probability < 90 %}linear-gradient(90deg, #f97316 0%, #ea580c 100%)
                        {% else %}linear-gradient(90deg, #ef4444 0%, #dc2626 100%)
                        {% endif %};">
                    </div>
                </div>
                <div class="meter-labels">
                    <span>0%</span>
                    <span>25%</span>
                    <span>50%</span>
                    <span>75%</span>
                    <span>100%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Section -->
    <div class="summary-section">
        <h3>สรุปข้อมูลของคุณ</h3>
        
        <div class="summary-grid">
            <!-- Physical Metrics -->
            <div class="summary-group">
                <h4>ข้อมูลทางกายภาพ</h4>
                <div class="summary-items">
                    {% if data.get('height') %}
                        <div class="summary-item">
                            <span class="label">ส่วนสูง:</span>
                            <span class="value">{{ data.get('height') }} ซม</span>
                        </div>
                    {% endif %}
                    {% if data.get('weight') %}
                        <div class="summary-item">
                            <span class="label">น้ำหนัก:</span>
                            <span class="value">{{ data.get('weight') }} กก</span>
                        </div>
                    {% endif %}
                    {% if data.get('bmi') %}
                        <div class="summary-item">
                            <span class="label">ดัชนีมวลกาย (BMI):</span>
                            <span class="value">
                                {{ "%.2f"|format(data.get('bmi')) }} kg/m²
                                {% set bmi_val = data.get('bmi') %}
                                {% if bmi_val < 18.5 %}
                                    <span class="bmi-status">(น้ำหนักต่ำกว่าเกณฑ์)</span>
                                {% elif bmi_val < 25 %}
                                    <span class="bmi-status green">(น้ำหนักปกติ)</span>
                                {% elif bmi_val < 30 %}
                                    <span class="bmi-status yellow">(น้ำหนักเกิน)</span>
                                {% else %}
                                    <span class="bmi-status red">(ภาวะอ้วน)</span>
                                {% endif %}
                            </span>
                        </div>
                    {% endif %}
                    {% if data.get('bmi_cat_code') is not none %}
                        <div class="summary-item">
                            <span class="label">เกณฑ์ BMI:</span>
                            <span class="value">
                                {% if data.get('bmi_cat_code') == 0 %}
                                    น้ำหนักต่ำกว่าเกณฑ์ (BMI &lt; 18.5)
                                {% elif data.get('bmi_cat_code') == 1 %}
                                    น้ำหนักปกติ (18.5 ≤ BMI &lt; 25)
                                {% elif data.get('bmi_cat_code') == 2 %}
                                    น้ำหนักเกิน (25 ≤ BMI &lt; 30)
                                {% elif data.get('bmi_cat_code') == 3 %}
                                    ภาวะอ้วน (BMI ≥ 30)
                                {% endif %}
                            </span>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Health Conditions -->
            <div class="summary-group">
                <h4>สภาวะสุขภาพ</h4>
                <div class="summary-items">
                    <div class="summary-item">
                        <span class="label">ความดันโลหิตสูง:</span>
                        <span class="value">{% if data.get('highbp') == '1' %}ใช่{% else %}ไม่{% endif %}</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">คอเลสเตอรอลสูง:</span>
                        <span class="value">{% if data.get('highchol') == '1' %}ใช่{% else %}ไม่{% endif %}</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">โรคหัวใจ:</span>
                        <span class="value">{% if data.get('heart') == '1' %}ใช่{% else %}ไม่{% endif %}</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">ปัญหาในการเดิน:</span>
                        <span class="value">{% if data.get('diffwalk') == '1' %}ใช่{% else %}ไม่{% endif %}</span>
                    </div>
                </div>
            </div>

            <!-- General Health -->
            <div class="summary-group">
                <h4>สุขภาพโดยทั่วไป</h4>
                <div class="summary-items">
                    <div class="summary-item">
                        <span class="label">สถานะสุขภาพ:</span>
                        <span class="value">
                            {% if data.get('genhlth') == '1' %}ยอดเยี่ยม
                            {% elif data.get('genhlth') == '2' %}ดี
                            {% elif data.get('genhlth') == '3' %}ปานกลาง
                            {% elif data.get('genhlth') == '4' %}แย่
                            {% elif data.get('genhlth') == '5' %}แย่มาก
                            {% else %}ไม่ระบุ{% endif %}
                        </span>
                    </div>
                    <div class="summary-item">
                        <span class="label">วันที่สุขภาพไม่ดี:</span>
                        <span class="value">{{ data.get('physhlth', '0') }} วัน/เดือน</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">กลุ่มอายุ:</span>
                        <span class="value">
                            {% set age_labels = {
                                '1': '18-24 ปี',
                                '2': '25-29 ปี',
                                '3': '30-34 ปี',
                                '4': '35-39 ปี',
                                '5': '40-44 ปี',
                                '6': '45-49 ปี',
                                '7': '50-54 ปี',
                                '8': '55-59 ปี',
                                '9': '60-64 ปี',
                                '10': '65-69 ปี',
                                '11': '70-74 ปี',
                                '12': '75-79 ปี',
                                '13': '80+ ปี'
                            } %}
                            {{ age_labels.get(data.get('age', '1'), 'ไม่ระบุ') }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Advanced Metrics -->
            <div class="summary-group">
                <h4>ข้อมูลเพิ่มเติม</h4>
                <div class="summary-items">
                    {% if data.get('bmi_age_interaction') is not none %}
                        <div class="summary-item">
                            <span class="label">BMI × Age Interaction:</span>
                            <span class="value">{{ data.get('bmi_age_interaction') }}</span>
                        </div>
                    {% endif %}
                    {% if data.get('model_choice') %}
                        <div class="summary-item">
                            <span class="label">โมเดลที่ใช้:</span>
                            <span class="value">{{ data.get('model_choice') }}</span>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Recommendation Section -->
    <div class="recommendation-section">
        <h3>คำแนะนำการดูแลสุขภาพ</h3>
        <div class="recommendation-card recommendation-{{ risk_data.risk_color }}">
            {% if probability is not none %}
                <div class="rec-content">
                    <h4>{{ risk_data.risk_level }} ({{ risk_data.category_id }})</h4>
                    {% if risk_data.recommendation and risk_data.recommendation != 'ไม่มีคำแนะนำ' %}
                        <div class="recommendation-text">
                            {{ risk_data.recommendation | replace('\n', '<br>') | safe }}
                        </div>
                    {% else %}
                        <p>ไม่มีข้อมูลคำแนะนำสำหรับกรณีนี้</p>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Notes Section -->
    <div class="notes-section">
        <h3>บันทึกเพิ่มเติม (เลือกไม่กรอกได้)</h3>
        <form method="POST" action="{{ url_for('save_result') }}" id="saveResultForm">
            <div class="form-group">
                <textarea id="userNote" name="userNote" class="user-note-input" 
                          placeholder="เขียนบันทึกหรือความคิดเห็นของคุณเกี่ยวกับผลประเมิน..." 
                          maxlength="500"></textarea>
                <div class="char-count">
                    <span id="charCount">0</span>/500
                </div>
            </div>

            <!-- Hidden fields to store data -->
            <!-- ส่วน “Hidden fields to store data” หมายถึง ช่องข้อมูลแบบซ่อน (hidden input fields) ที่อยู่ใน <form> 
                โดยที่ ผู้ใช้มองไม่เห็นบนหน้าเว็บ แต่จะถูกส่งไปพร้อมกับฟอร์มเมื่อกด “บันทึกผลการประเมิน” -->
            <input type="hidden" name="prediction" value="{{ prediction }}">
            <input type="hidden" name="probability" value="{{ probability }}">
            <input type="hidden" name="bmi" value="{{ data.get('bmi', 0) }}">
            <input type="hidden" name="model_used" value="{{ data.get('model_choice', 'random_forest') }}">
            
            <div class="action-buttons">
                <a href="{{ url_for('predict_step', step=1) }}" class="btn btn-start-over">
                    <i class="fa-solid fa-rotate-left"></i> ประเมินใหม่
                </a>
                <button type="submit" class="btn btn-save">
                    <i class="fa-solid fa-floppy-disk"></i> บันทึกผลการประเมิน
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Update character count
    document.getElementById('userNote').addEventListener('input', function() {
        document.getElementById('charCount').textContent = this.value.length;
    });

    // Handle form submission
    document.getElementById('saveResultForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const btn = this.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.textContent = 'กำลังบันทึก...';
        
        fetch("{{ url_for('save_result') }}", {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('บันทึกผลการประเมินเรียบร้อยแล้ว ✓');
                setTimeout(() => {
                    window.location.href = "{{ url_for('home') }}";
                }, 1000);
            } else {
                alert('เกิดข้อผิดพลาด: ' + (data.message || 'ไม่สามารถบันทึกได้'));
                btn.disabled = false;
                btn.textContent = 'บันทึกผลการประเมิน';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('เกิดข้อผิดพลาดในการบันทึก: ' + error.message);
            btn.disabled = false;
            btn.textContent = 'บันทึกผลการประเมิน';
        });
    });
</script>

{% endblock %}