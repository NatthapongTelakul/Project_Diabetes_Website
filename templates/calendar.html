{% extends "header.html" %}
{% block content %}
<div class="container mt-5 mb-5">
  <h2 class="mb-4 text-center">ปฏิทินกิจกรรม</h2>
  <div id="calendar"></div>
</div>

<!-- Modal เพิ่มกิจกรรม -->
<div class="modal fade" id="addEventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">เพิ่มกิจกรรม</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p id="selectedDate" class="fw-bold"></p>
        <input type="text" id="eventText" class="form-control" placeholder="พิมพ์ชื่อกิจกรรม...">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
        <button class="btn btn-primary" id="saveEventBtn">บันทึกกิจกรรม</button>
      </div>
    </div>
  </div>
</div>

<!-- FullCalendar & Bootstrap CDN -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<style>
  body {
    background-color: #f5f7fa;
  }
  #calendar {
    background-color: white;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
  }
  .fc-toolbar-title {
    font-size: 1.5rem !important;
    color: #007bff;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('calendar');
  const modal = new bootstrap.Modal(document.getElementById('addEventModal'));
  let selectedDate = '';

  // สร้างปฏิทิน
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    selectable: true,
    locale: 'th',
    height: 'auto',
    dateClick: function(info) {
      selectedDate = info.dateStr;
      document.getElementById('selectedDate').innerText = 'วันที่ ' + info.dateStr;
      modal.show();
    },
  });

  calendar.render();

  // โหลดกิจกรรมจาก backend
  fetch('/calendar/events')
    .then(res => res.json())
    .then(data => {
      data.forEach(ev => {
        calendar.addEvent({
          title: ev[1],
          start: ev[0],
          allDay: true
        });
      });
    });

  // เพิ่มกิจกรรมใหม่
  document.getElementById('saveEventBtn').addEventListener('click', () => {
    const text = document.getElementById('eventText').value.trim();
    if (!text) return alert('กรุณากรอกชื่อกิจกรรม');

    fetch('/calendar/add', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({date: selectedDate, text: text})
    })
    .then(res => res.json())
    .then(result => {
      alert(result.message);
      if (result.success) {
        calendar.addEvent({
          title: text,
          start: selectedDate,
          allDay: true
        });
        modal.hide();
        document.getElementById('eventText').value = '';
      }
    });
  });
});
</script>
{% endblock %}
