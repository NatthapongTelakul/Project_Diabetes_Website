{% extends "header.html" %}
{% block content %}
<div class="container mt-5 mb-5">
  <div class="row">
    <div class="col-md-12">
      <h2 class="mb-4 text-center">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h2>
      <div id="calendar"></div>
    </div>
  </div>
</div>

<!-- Modal ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° -->
<div class="modal fade" id="addEventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3" id="selectedDate"></p>
        <div class="mb-3">
          <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
          <input type="text" id="eventText" class="form-control" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°..." maxlength="255">
          <small class="text-muted" id="charCount">0/255</small>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn btn-primary" id="saveEventBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î -->
<div class="modal fade" id="eventDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3" id="detailDate"></p>
        <p class="fs-5" id="detailText"></p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-warning" id="editEventBtn">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        <button class="btn btn-danger" id="deleteEventBtn">‡∏•‡∏ö</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° -->
<div class="modal fade" id="editEventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
          <input type="text" id="editEventText" class="form-control" maxlength="255">
          <small class="text-muted" id="editCharCount">0/255</small>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn btn-primary" id="updateEventBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap CDN -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- FullCalendar CDN -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<!-- Thai Locale for FullCalendar -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales/th.global.min.js"></script>

<style>
  body {
    background-color: #f5f7fa;
  }
  
  #calendar {
    background-color: white;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
  }

  .fc-toolbar-title {
    font-size: 1.5rem !important;
    color: #007bff;
    font-weight: 600;
  }

  .fc-button-primary:not(:disabled).fc-button-active,
  .fc-button-primary:not(:disabled):hover {
    background-color: #007bff !important;
    border-color: #007bff !important;
  }

  .fc-button-primary:not(:disabled) {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
  }

  .fc-daygrid-day.fc-day-other {
    background-color: #f9f9f9;
  }

  .fc-daygrid-day:hover {
    background-color: #f0f0f0;
  }

  .fc-event {
    padding: 2px 4px !important;
    font-size: 0.85rem;
  }

  .fc-event-title {
    font-weight: 500;
  }

  #charCount, #editCharCount {
    display: block;
    margin-top: 5px;
  }

  .badge {
    font-size: 0.8rem;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('calendar');
  const addEventModal = new bootstrap.Modal(document.getElementById('addEventModal'));
  const eventDetailsModal = new bootstrap.Modal(document.getElementById('eventDetailsModal'));
  const editEventModal = new bootstrap.Modal(document.getElementById('editEventModal'));

  let selectedDate = '';
  let selectedEventId = null;
  let allEvents = [];

  // ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏≠‡∏±‡∏Å‡∏©‡∏£
  document.getElementById('eventText').addEventListener('input', (e) => {
    document.getElementById('charCount').textContent = e.target.value.length + '/255';
  });

  document.getElementById('editEventText').addEventListener('input', (e) => {
    document.getElementById('editCharCount').textContent = e.target.value.length + '/255';
  });

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    selectable: true,
    locale: 'th',
    height: 'auto',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,dayGridWeek'
    },
    dateClick: function(info) {
      selectedDate = info.dateStr;
      const date = new Date(selectedDate);
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const formattedDate = date.toLocaleDateString('th-TH', options);
      document.getElementById('selectedDate').innerText = 'üìç ' + formattedDate;
      document.getElementById('eventText').value = '';
      document.getElementById('charCount').textContent = '0/255';
      addEventModal.show();
    },
    eventClick: function(info) {
      selectedEventId = parseInt(info.event.id);
      const event = allEvents.find(e => e.id === selectedEventId);
      if (event) {
        const date = new Date(event.start);
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const formattedDate = date.toLocaleDateString('th-TH', options);
        document.getElementById('detailDate').innerText = 'üìç ' + formattedDate;
        document.getElementById('detailText').innerText = event.title;
        eventDetailsModal.show();
      }
    }
  });

  calendar.render();

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏≤‡∏Å backend
  function loadEvents() {
    fetch('/calendar/events')
      .then(res => res.json())
      .then(data => {
        allEvents = data;
        calendar.removeAllEvents();
        data.forEach(ev => {
          calendar.addEvent({
            id: ev.id,
            title: ev.title,
            start: ev.start,
            allDay: true
          });
        });
      })
      .catch(err => console.error('Error loading events:', err));
  }

  loadEvents();

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
  document.getElementById('saveEventBtn').addEventListener('click', () => {
    const text = document.getElementById('eventText').value.trim();
    if (!text) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°');
      return;
    }

    fetch('/calendar/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ date: selectedDate, text: text })
    })
    .then(res => res.json())
    .then(result => {
      if (result.success) {
        alert(result.message);
        loadEvents();
        addEventModal.hide();
        document.getElementById('eventText').value = '';
        document.getElementById('charCount').textContent = '0/255';
      } else {
        alert('‚ùå ' + result.message);
      }
    })
    .catch(err => {
      console.error('Error:', err);
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
    });
  });

  // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
  document.getElementById('editEventBtn').addEventListener('click', () => {
    eventDetailsModal.hide();
    const event = allEvents.find(e => e.id === selectedEventId);
    if (event) {
      document.getElementById('editEventText').value = event.title;
      document.getElementById('editCharCount').textContent = event.title.length + '/255';
      editEventModal.show();
    }
  });

  document.getElementById('updateEventBtn').addEventListener('click', () => {
    const text = document.getElementById('editEventText').value.trim();
    if (!text) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°');
      return;
    }

    fetch(`/calendar/update/${selectedEventId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: text })
    })
    .then(res => res.json())
    .then(result => {
      if (result.success) {
        alert(result.message);
        loadEvents();
        editEventModal.hide();
      } else {
        alert('‚ùå ' + result.message);
      }
    })
    .catch(err => {
      console.error('Error:', err);
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
    });
  });

  // ‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
  document.getElementById('deleteEventBtn').addEventListener('click', () => {
    if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

    fetch(`/calendar/delete/${selectedEventId}`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(result => {
      if (result.success) {
        alert(result.message);
        loadEvents();
        eventDetailsModal.hide();
      } else {
        alert('‚ùå ' + result.message);
      }
    })
    .catch(err => {
      console.error('Error:', err);
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
    });
  });
});
</script>
{% endblock %}